#!/bin/bash
# Script de monitoring qui d√©truit la VM quand l'utilisateur se d√©connecte

SESSION_ID="{{ vm_name }}"
ORCHESTRATOR="{{ orchestrator_url }}"
CHECK_INTERVAL=30  # V√©rifier toutes les 30 secondes

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | systemd-cat -t inactivity-monitor
}

log "üöÄ D√©marrage du monitoring pour VM: $SESSION_ID"
log "üîó Orchestrateur: $ORCHESTRATOR"

# Attendre que le syst√®me soit compl√®tement d√©marr√©
sleep 60

# Compteur de v√©rifications sans session
NO_SESSION_COUNT=0
MAX_NO_SESSION=2  # Attendre 2 v√©rifications (1 minute) avant de d√©truire

while true; do
    # V√©rifier plusieurs indicateurs de session active
    
    # 1. Sessions XRDP actives (connect√©es)
    XRDP_CONNECTED=$(ss -tnp | grep :3389 | grep ESTABLISHED | wc -l)
    
    # 2. Sessions utilisateur logg√©es (excluant root et ubuntu syst√®me)
    ACTIVE_LOGINS=$(who | awk '{print $1}' | grep -v "^root$" | grep -v "^ubuntu$" | sort -u | wc -l)
    
    # 3. Processus de session XFCE actifs
    XFCE_SESSIONS=$(pgrep -f "xfce4-session" | wc -l)
    
    # Une session est active si AU MOINS un des crit√®res est vrai
    if [ "$XRDP_CONNECTED" -eq 0 ] && [ "$ACTIVE_LOGINS" -eq 0 ] && [ "$XFCE_SESSIONS" -eq 0 ]; then
        NO_SESSION_COUNT=$((NO_SESSION_COUNT + 1))
        log "‚ö†Ô∏è  Aucune session active (compteur: $NO_SESSION_COUNT/$MAX_NO_SESSION)"
        log "   - Connexions RDP: $XRDP_CONNECTED"
        log "   - Logins actifs: $ACTIVE_LOGINS" 
        log "   - Sessions XFCE: $XFCE_SESSIONS"
        
        if [ "$NO_SESSION_COUNT" -ge "$MAX_NO_SESSION" ]; then
            log "üí• Aucune session active d√©tect√©e - D√©clenchement de la destruction"
            
            # Appeler l'API
            response=$(curl -s -X POST \
                -H "Content-Type: application/json" \
                -d "{\"session_id\": \"$SESSION_ID\"}" \
                "$ORCHESTRATOR/api/session/destroy" \
                --max-time 10)
            
            if [ $? -eq 0 ]; then
                log "‚úÖ Demande de destruction envoy√©e avec succ√®s"
                log "üì§ R√©ponse: $response"
            else
                log "‚ùå ERREUR: Impossible de contacter l'orchestrateur"
            fi
            
            break
        fi
    else
        if [ "$NO_SESSION_COUNT" -gt 0 ]; then
            log "‚úÖ Session active d√©tect√©e - R√©initialisation du compteur"
        fi
        NO_SESSION_COUNT=0
        log "üë§ Session active: RDP=$XRDP_CONNECTED, Logins=$ACTIVE_LOGINS, XFCE=$XFCE_SESSIONS"
    fi
    
    sleep "$CHECK_INTERVAL"
done

log "üõë Arr√™t du monitoring"
